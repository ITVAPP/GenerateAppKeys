name: Generate App Store Keys

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
      
      - name: Create keys directory
        run: mkdir -p keys
          
      - name: Generate Android Keystore
        run: |
          cd keys
          
          # ç”Ÿæˆ Google Play å‘å¸ƒè¯ä¹¦
          keytool -genkey -v \
            -keystore android_keystore.jks \
            -storepass iappplayer2024 \
            -alias upload \
            -keypass iappplayer2024 \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10950 \
            -dname "CN=ITVAPP, OU=Mobile Development, O=ITVAPP, L=Beijing, ST=Beijing, C=CN" \
            -noprompt
          
          # åˆ›å»º Android key.propertiesï¼ˆç”¨äºŽ example/android ç›®å½•ï¼‰
          cat > android_key.properties << EOF
          storePassword=iappplayer2024
          keyPassword=iappplayer2024
          keyAlias=upload
          storeFile=../../keys/android_keystore.jks
          EOF
          
          # æ˜¾ç¤º Android è¯ä¹¦ä¿¡æ¯
          echo "=== Android è¯ä¹¦ä¿¡æ¯ ==="
          keytool -list -v -keystore android_keystore.jks -storepass iappplayer2024 | grep -E "Alias|Owner|Valid" || true
          
          # ç”Ÿæˆ base64 ç¼–ç 
          echo ""
          echo "=== ç”Ÿæˆ Base64 ç¼–ç  ==="
          base64 -w 0 android_keystore.jks > android_keystore_base64.txt
          echo "âœ… Base64 ç¼–ç å·²ä¿å­˜åˆ°: android_keystore_base64.txt"
          
          # åˆ›å»º GitHub Secrets è®¾ç½®è¯´æ˜Ž
          cat > github_secrets_setup.md << 'EOF'
          # GitHub Secrets è®¾ç½®æŒ‡å—
          
          ## è®¾ç½®æ­¥éª¤
          
          1. **è¿›å…¥ä»“åº“è®¾ç½®**
             - æ‰“å¼€ä½ çš„ GitHub ä»“åº“
             - ç‚¹å‡» **Settings** (è®¾ç½®)
             - å·¦ä¾§èœå•é€‰æ‹© **Secrets and variables** â†’ **Actions**
          
          2. **æ·»åŠ ä»¥ä¸‹ Secrets**
             
             ç‚¹å‡» **New repository secret** æŒ‰é’®ï¼Œé€ä¸ªæ·»åŠ ï¼š
             
             ### KEYSTORE_BASE64
             - **Name**: `KEYSTORE_BASE64`
             - **Value**: å¤åˆ¶ `android_keystore_base64.txt` æ–‡ä»¶çš„å…¨éƒ¨å†…å®¹
             
             ### KEYSTORE_PASSWORD
             - **Name**: `KEYSTORE_PASSWORD`
             - **Value**: `iappplayer2024`
             
             ### KEY_ALIAS
             - **Name**: `KEY_ALIAS`
             - **Value**: `upload`
          
          ## åœ¨ GitHub Actions ä¸­ä½¿ç”¨
          
          åœ¨ä½ çš„æž„å»ºå·¥ä½œæµä¸­æ·»åŠ ä»¥ä¸‹æ­¥éª¤ï¼š
          
          ```yaml
          - name: Setup signing
            env:
              KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
              KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
              KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
            run: |
              cd example/android
              
              # è§£ç å¯†é’¥åº“
              echo "$KEYSTORE_BASE64" | base64 --decode > app/release.keystore
              
              # åˆ›å»º key.properties
              cat > key.properties << EOF
              storePassword=$KEYSTORE_PASSWORD
              keyPassword=$KEYSTORE_PASSWORD
              keyAlias=$KEY_ALIAS
              storeFile=release.keystore
              EOF
          ```
          
          ## å®‰å…¨æé†’
          
          - âœ… Secrets æ˜¯åŠ å¯†å­˜å‚¨çš„ï¼Œåªæœ‰ Actions å¯ä»¥è®¿é—®
          - âœ… Secrets ä¸ä¼šåœ¨æ—¥å¿—ä¸­æ˜¾ç¤º
          - âŒ ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†ç 
          - âŒ ä¸è¦å°† base64 æ–‡ä»¶æäº¤åˆ°ä»“åº“
          
          ## å¿«é€Ÿå¤åˆ¶å‘½ä»¤
          
          å¤åˆ¶ base64 å†…å®¹åˆ°å‰ªè´´æ¿ï¼š
          
          **Windows (PowerShell)**:
          ```powershell
          Get-Content android_keystore_base64.txt | Set-Clipboard
          ```
          
          **macOS**:
          ```bash
          cat android_keystore_base64.txt | pbcopy
          ```
          
          **Linux**:
          ```bash
          cat android_keystore_base64.txt | xclip -selection clipboard
          ```
          EOF
          
      - name: Generate iOS Development Files
        run: |
          cd keys
          
          # åˆ›å»º iOS å¼€å‘è¯´æ˜Žæ–‡ä»¶
          cat > ios_certificates_guide.md << 'EOF'
          # iOS App Store å‘å¸ƒæŒ‡å—
          
          ## éœ€è¦çš„è¯ä¹¦å’Œæ–‡ä»¶
          
          1. **Apple Developer è´¦å·** (å¿…éœ€)
             - è®¿é—® https://developer.apple.com
             - å¹´è´¹ $99 USD
          
          2. **éœ€è¦åˆ›å»ºçš„è¯ä¹¦**ï¼š
             - iOS Distribution Certificate (å‘å¸ƒè¯ä¹¦)
             - Provisioning Profile (é…ç½®æ–‡ä»¶)
          
          ## åˆ›å»ºæ­¥éª¤
          
          ### 1. åˆ›å»º App ID
          1. ç™»å½• Apple Developer
          2. è¿›å…¥ Certificates, Identifiers & Profiles
          3. ç‚¹å‡» Identifiers â†’ + æŒ‰é’®
          4. é€‰æ‹© App IDs â†’ Continue
          5. è¾“å…¥ï¼š
             - Description: IAppPlayer
             - Bundle ID: net.itvapp.iapp_player_example
          6. é€‰æ‹©éœ€è¦çš„ Capabilities
          7. Register
          
          ### 2. åˆ›å»ºå‘å¸ƒè¯ä¹¦
          1. ç‚¹å‡» Certificates â†’ + æŒ‰é’®
          2. é€‰æ‹© iOS Distribution â†’ Continue
          3. æŒ‰ç…§æŒ‡ç¤ºåˆ›å»º CSR æ–‡ä»¶
          4. ä¸Šä¼  CSR æ–‡ä»¶
          5. ä¸‹è½½è¯ä¹¦ (.cer æ–‡ä»¶)
          
          ### 3. åˆ›å»º Provisioning Profile
          1. ç‚¹å‡» Profiles â†’ + æŒ‰é’®
          2. é€‰æ‹© App Store â†’ Continue
          3. é€‰æ‹©ä½ çš„ App ID
          4. é€‰æ‹©ä½ çš„å‘å¸ƒè¯ä¹¦
          5. å‘½åä¸º "IAppPlayer Distribution"
          6. ä¸‹è½½ .mobileprovision æ–‡ä»¶
          
          ### 4. å¯¼å‡º p12 æ–‡ä»¶
          1. åŒå‡»å®‰è£…ä¸‹è½½çš„ .cer æ–‡ä»¶
          2. æ‰“å¼€ Keychain Access (é’¥åŒ™ä¸²è®¿é—®)
          3. æ‰¾åˆ°ä½ çš„è¯ä¹¦
          4. å³é”® â†’ Export
          5. ä¿å­˜ä¸º .p12 æ ¼å¼
          6. è®¾ç½®å¯†ç  (å»ºè®®: iappplayer2024)
          
          ## æ–‡ä»¶æ”¾ç½®ä½ç½®
          
          å°†ä»¥ä¸‹æ–‡ä»¶æ”¾å…¥ keys ç›®å½•ï¼š
          - `ios_distribution.p12` - å‘å¸ƒè¯ä¹¦
          - `IAppPlayer_Distribution.mobileprovision` - é…ç½®æ–‡ä»¶
          
          ## åœ¨ GitHub Actions ä¸­ä½¿ç”¨
          
          1. å°† p12 æ–‡ä»¶è½¬ä¸º base64:
             ```bash
             base64 -w 0 ios_distribution.p12 > ios_p12_base64.txt
             ```
          
          2. å°† mobileprovision è½¬ä¸º base64:
             ```bash
             base64 -w 0 IAppPlayer_Distribution.mobileprovision > ios_provision_base64.txt
             ```
          
          3. åœ¨ GitHub Secrets ä¸­æ·»åŠ ï¼š
             - IOS_P12_BASE64
             - IOS_P12_PASSWORD
             - IOS_PROVISION_BASE64
             - IOS_TEAM_ID
          EOF
          
          # åˆ›å»ºç¤ºä¾‹ ExportOptions.plist
          cat > ExportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>YOUR_TEAM_ID</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>net.itvapp.iapp_player_example</key>
                  <string>IAppPlayer Distribution</string>
              </dict>
          </dict>
          </plist>
          EOF
          
          # åˆ›å»ºä½¿ç”¨è¯´æ˜Ž
          cat > README.md << 'EOF'
          # è¯ä¹¦ä½¿ç”¨è¯´æ˜Ž
          
          ## ç”Ÿæˆçš„æ–‡ä»¶
          
          - `android_keystore.jks` - Android å‘å¸ƒè¯ä¹¦
          - `android_key.properties` - Android ç­¾åé…ç½®
          - `android_keystore_base64.txt` - è¯ä¹¦çš„ Base64 ç¼–ç ï¼ˆç”¨äºŽ GitHub Secretsï¼‰
          - `github_secrets_setup.md` - GitHub Secrets è¯¦ç»†è®¾ç½®æŒ‡å—
          - `ios_certificates_guide.md` - iOS è¯ä¹¦åˆ›å»ºæŒ‡å—
          - `ExportOptions.plist` - iOS å¯¼å‡ºé…ç½®æ¨¡æ¿
          
          ## Android å¿«é€Ÿå¼€å§‹
          
          ### æ–¹å¼ä¸€ï¼šæœ¬åœ°ä½¿ç”¨
          1. å°† `android_keystore.jks` å¤åˆ¶åˆ° `example/android/keys/`
          2. åœ¨ `example/android/key.properties` ä¸­é…ç½®ï¼š
             ```
             storePassword=iappplayer2024
             keyPassword=iappplayer2024
             keyAlias=upload
             storeFile=../../keys/android_keystore.jks
             ```
          
          ### æ–¹å¼äºŒï¼šGitHub Actions ä½¿ç”¨
          1. æŸ¥çœ‹ `github_secrets_setup.md` æ–‡ä»¶
          2. æŒ‰ç…§æŒ‡å—è®¾ç½® GitHub Secrets
          3. åœ¨å·¥ä½œæµä¸­ä½¿ç”¨ Secrets è‡ªåŠ¨ç­¾å
          
          ## è¯ä¹¦ä¿¡æ¯
          
          - **å¯†é’¥åº“å¯†ç **: iappplayer2024
          - **å¯†é’¥å¯†ç **: iappplayer2024
          - **å¯†é’¥åˆ«å**: upload
          - **æœ‰æ•ˆæœŸ**: 30 å¹´
          - **é€‚ç”¨äºŽ**: Google Play å‘å¸ƒ
          
          ## iOS
          
          iOS è¯ä¹¦éœ€è¦ Apple Developer è´¦å·æ‰‹åŠ¨åˆ›å»ºã€‚
          è¯¦ç»†æ­¥éª¤è¯·æŸ¥çœ‹ `ios_certificates_guide.md`ã€‚
          
          ## å®‰å…¨æé†’
          
          **é‡è¦**ï¼š
          - ðŸ”’ å¦¥å–„ä¿ç®¡ `android_keystore.jks`ï¼Œä¸¢å¤±åŽæ— æ³•æ¢å¤
          - ðŸ”’ ä¸è¦å°†è¯ä¹¦æ–‡ä»¶æäº¤åˆ°å…¬å¼€ä»“åº“
          - ðŸ”’ ä½¿ç”¨ GitHub Secrets å­˜å‚¨æ•æ„Ÿä¿¡æ¯
          - ðŸ”’ å®šæœŸå¤‡ä»½è¯ä¹¦æ–‡ä»¶åˆ°å®‰å…¨ä½ç½®
          - âš ï¸  æ‰€æœ‰ Google Play æ›´æ–°éƒ½éœ€è¦ä½¿ç”¨ç›¸åŒçš„è¯ä¹¦
          EOF
          
      - name: Display generated files
        run: |
          echo "=== ç”Ÿæˆçš„æ–‡ä»¶ ==="
          ls -la keys/
          echo ""
          echo "=== ç”Ÿæˆå®Œæˆ ==="
          echo "âœ… Android è¯ä¹¦å·²ç”Ÿæˆ: keys/android_keystore.jks"
          echo "âœ… Android é…ç½®å·²ç”Ÿæˆ: keys/android_key.properties"
          echo "âœ… Base64 ç¼–ç å·²ç”Ÿæˆ: keys/android_keystore_base64.txt"
          echo "âœ… GitHub Secrets è®¾ç½®æŒ‡å—: keys/github_secrets_setup.md"
          echo "âœ… iOS æŒ‡å—å·²ç”Ÿæˆ: keys/ios_certificates_guide.md"
          echo "âœ… ä½¿ç”¨è¯´æ˜Žå·²ç”Ÿæˆ: keys/README.md"
          echo ""
          echo "ðŸ“‹ ä¸‹ä¸€æ­¥ï¼š"
          echo "1. ä¸‹è½½ app-store-keys åŽ‹ç¼©åŒ…"
          echo "2. æŸ¥çœ‹ github_secrets_setup.md è®¾ç½® GitHub Secrets"
          echo "3. å°† base64 å†…å®¹æ·»åŠ åˆ° GitHub Secrets"
          echo ""
          echo "âš ï¸  iOS è¯ä¹¦éœ€è¦ Apple Developer è´¦å·æ‰‹åŠ¨åˆ›å»º"
          
      - name: Commit keys directory
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # åˆ›å»º .gitignore é˜²æ­¢æäº¤ base64 æ–‡ä»¶
          echo "android_keystore_base64.txt" > keys/.gitignore
          
          git add keys/
          git diff --staged --quiet || git commit -m "Add app store keys and guides [skip ci]"
          git push || echo "No changes to push"
          
      - name: Upload keys as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-store-keys
          path: keys/
          retention-days: 90
