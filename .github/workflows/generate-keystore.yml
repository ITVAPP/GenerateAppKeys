name: Generate Custom App Store Keys

on:
  workflow_dispatch:
    inputs:
      keystore_name:
        description: 'è¯ä¹¦åç§°ï¼ˆå°†ä½œä¸ºç›®å½•åï¼‰'
        required: false
        default: 'iappplayer'
        type: string
      keystore_password:
        description: 'å¯†é’¥åº“å¯†ç '
        required: false
        default: 'iappplayer2024'
        type: string
      key_alias:
        description: 'å¯†é’¥åˆ«å'
        required: false
        default: 'upload'
        type: string
      organization:
        description: 'ç»„ç»‡åç§°'
        required: false
        default: 'ITVAPP'
        type: string

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
      
      - name: Set parameters
        id: params
        run: |
          # ä½¿ç”¨è¾“å…¥å€¼æˆ–é»˜è®¤å€¼
          KEYSTORE_NAME="${{ github.event.inputs.keystore_name }}"
          KEYSTORE_PASSWORD="${{ github.event.inputs.keystore_password }}"
          KEY_ALIAS="${{ github.event.inputs.key_alias }}"
          ORGANIZATION="${{ github.event.inputs.organization }}"
          
          # å¦‚æžœä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼
          KEYSTORE_NAME=${KEYSTORE_NAME:-iappplayer}
          KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD:-iappplayer2024}
          KEY_ALIAS=${KEY_ALIAS:-upload}
          ORGANIZATION=${ORGANIZATION:-ITVAPP}
          
          # éªŒè¯è¯ä¹¦ååªåŒ…å«å­—æ¯ã€æ•°å­—ã€è¿žå­—ç¬¦å’Œä¸‹åˆ’çº¿
          if ! [[ "$KEYSTORE_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "âŒ é”™è¯¯ï¼šè¯ä¹¦ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€è¿žå­—ç¬¦å’Œä¸‹åˆ’çº¿"
            exit 1
          fi
          
          # è¾“å‡ºå‚æ•°
          echo "keystore_name=$KEYSTORE_NAME" >> $GITHUB_OUTPUT
          echo "keystore_password=$KEYSTORE_PASSWORD" >> $GITHUB_OUTPUT
          echo "key_alias=$KEY_ALIAS" >> $GITHUB_OUTPUT
          echo "organization=$ORGANIZATION" >> $GITHUB_OUTPUT
          echo "keystore_dir=keys/$KEYSTORE_NAME" >> $GITHUB_OUTPUT
          echo "keystore_file=${KEYSTORE_NAME}_keystore.jks" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºå‚æ•°
          echo "=== ä½¿ç”¨ä»¥ä¸‹å‚æ•° ==="
          echo "ðŸ“ è¯ä¹¦ç›®å½•: keys/$KEYSTORE_NAME"
          echo "ðŸ”‘ è¯ä¹¦æ–‡ä»¶: ${KEYSTORE_NAME}_keystore.jks"
          echo "ðŸ¢ ç»„ç»‡åç§°: $ORGANIZATION"
          echo "ðŸ“ å¯†é’¥åˆ«å: $KEY_ALIAS"
          echo "ðŸ”’ å¯†é’¥å¯†ç : ****$(echo $KEYSTORE_PASSWORD | tail -c 5)"
      
      - name: Create certificate directory
        run: |
          KEYSTORE_DIR="${{ steps.params.outputs.keystore_dir }}"
          
          # å¦‚æžœç›®å½•å·²å­˜åœ¨ï¼Œåˆ é™¤å¹¶é‡å»º
          if [ -d "$KEYSTORE_DIR" ]; then
            echo "âš ï¸  ç›®å½• $KEYSTORE_DIR å·²å­˜åœ¨ï¼Œå°†è¦†ç›–..."
            rm -rf "$KEYSTORE_DIR"
          fi
          
          mkdir -p "$KEYSTORE_DIR"
          echo "âœ… åˆ›å»ºç›®å½•: $KEYSTORE_DIR"
          
      - name: Generate Android Keystore
        run: |
          cd "${{ steps.params.outputs.keystore_dir }}"
          
          KEYSTORE_FILE="${{ steps.params.outputs.keystore_file }}"
          KEYSTORE_PASSWORD="${{ steps.params.outputs.keystore_password }}"
          KEY_ALIAS="${{ steps.params.outputs.key_alias }}"
          ORGANIZATION="${{ steps.params.outputs.organization }}"
          
          # ç”Ÿæˆè¯ä¹¦
          keytool -genkey -v \
            -keystore "$KEYSTORE_FILE" \
            -storepass "$KEYSTORE_PASSWORD" \
            -alias "$KEY_ALIAS" \
            -keypass "$KEYSTORE_PASSWORD" \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10950 \
            -dname "CN=$ORGANIZATION, OU=Mobile Development, O=$ORGANIZATION, L=Beijing, ST=Beijing, C=CN" \
            -noprompt
          
          echo "âœ… è¯ä¹¦ç”ŸæˆæˆåŠŸ: $KEYSTORE_FILE"
          
          # æ˜¾ç¤ºè¯ä¹¦ä¿¡æ¯
          echo ""
          echo "=== è¯ä¹¦ä¿¡æ¯ ==="
          keytool -list -v -keystore "$KEYSTORE_FILE" -storepass "$KEYSTORE_PASSWORD" | grep -E "Alias|Owner|Valid" || true
          
          # ç”Ÿæˆ Base64
          echo ""
          echo "=== ç”Ÿæˆ Base64 ç¼–ç  ==="
          base64 -w 0 "$KEYSTORE_FILE" > "${KEYSTORE_FILE%.jks}_base64.txt"
          echo "âœ… Base64 æ–‡ä»¶: ${KEYSTORE_FILE%.jks}_base64.txt"
          
      - name: Generate configuration files
        run: |
          cd "${{ steps.params.outputs.keystore_dir }}"
          
          KEYSTORE_NAME="${{ steps.params.outputs.keystore_name }}"
          KEYSTORE_FILE="${{ steps.params.outputs.keystore_file }}"
          KEYSTORE_PASSWORD="${{ steps.params.outputs.keystore_password }}"
          KEY_ALIAS="${{ steps.params.outputs.key_alias }}"
          
          # åˆ›å»º key.properties
          cat > key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=../../keys/$KEYSTORE_NAME/$KEYSTORE_FILE
          EOF
          
          # åˆ›å»º GitHub Secrets è®¾ç½®è¯´æ˜Ž
          cat > github_secrets_setup.md << EOF
          # GitHub Secrets è®¾ç½®æŒ‡å— - $KEYSTORE_NAME
          
          ## è®¾ç½®æ­¥éª¤
          
          1. **è¿›å…¥ä»“åº“è®¾ç½®**
             - æ‰“å¼€ä½ çš„ GitHub ä»“åº“
             - ç‚¹å‡» **Settings** (è®¾ç½®)
             - å·¦ä¾§èœå•é€‰æ‹© **Secrets and variables** â†’ **Actions**
          
          2. **æ·»åŠ ä»¥ä¸‹ Secrets**
             
             ç‚¹å‡» **New repository secret** æŒ‰é’®ï¼Œé€ä¸ªæ·»åŠ ï¼š
             
             ### é€‰é¡¹ Aï¼šä½¿ç”¨é»˜è®¤åç§°
             - **KEYSTORE_BASE64**: å¤åˆ¶ \`${KEYSTORE_FILE%.jks}_base64.txt\` çš„å†…å®¹
             - **KEYSTORE_PASSWORD**: \`$KEYSTORE_PASSWORD\`
             - **KEY_ALIAS**: \`$KEY_ALIAS\`
             
             ### é€‰é¡¹ Bï¼šä½¿ç”¨è‡ªå®šä¹‰åç§°ï¼ˆå¤šè¯ä¹¦åœºæ™¯ï¼‰
             - **${KEYSTORE_NAME^^}_KEYSTORE_BASE64**: å¤åˆ¶ \`${KEYSTORE_FILE%.jks}_base64.txt\` çš„å†…å®¹
             - **${KEYSTORE_NAME^^}_KEYSTORE_PASSWORD**: \`$KEYSTORE_PASSWORD\`
             - **${KEYSTORE_NAME^^}_KEY_ALIAS**: \`$KEY_ALIAS\`
          
          ## åœ¨ GitHub Actions ä¸­ä½¿ç”¨
          
          \`\`\`yaml
          - name: Setup signing for $KEYSTORE_NAME
            env:
              KEYSTORE_BASE64: \${{ secrets.KEYSTORE_BASE64 }}
              KEYSTORE_PASSWORD: \${{ secrets.KEYSTORE_PASSWORD }}
              KEY_ALIAS: \${{ secrets.KEY_ALIAS }}
            run: |
              cd example/android
              
              # è§£ç å¯†é’¥åº“
              echo "\$KEYSTORE_BASE64" | base64 --decode > app/$KEYSTORE_FILE
              
              # åˆ›å»º key.properties
              cat > key.properties << PROPS
              storePassword=\$KEYSTORE_PASSWORD
              keyPassword=\$KEYSTORE_PASSWORD
              keyAlias=\$KEY_ALIAS
              storeFile=$KEYSTORE_FILE
              PROPS
          \`\`\`
          EOF
          
          # åˆ›å»º README
          cat > README.md << EOF
          # $KEYSTORE_NAME è¯ä¹¦ä½¿ç”¨è¯´æ˜Ž
          
          ## è¯ä¹¦ä¿¡æ¯
          
          - **è¯ä¹¦æ–‡ä»¶**: \`$KEYSTORE_FILE\`
          - **å¯†é’¥åº“å¯†ç **: \`$KEYSTORE_PASSWORD\`
          - **å¯†é’¥å¯†ç **: \`$KEYSTORE_PASSWORD\`
          - **å¯†é’¥åˆ«å**: \`$KEY_ALIAS\`
          - **ç»„ç»‡**: \`${{ steps.params.outputs.organization }}\`
          - **æœ‰æ•ˆæœŸ**: 30 å¹´
          - **åˆ›å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          
          ## æ–‡ä»¶è¯´æ˜Ž
          
          - \`$KEYSTORE_FILE\` - Android å‘å¸ƒè¯ä¹¦
          - \`key.properties\` - Android ç­¾åé…ç½®
          - \`${KEYSTORE_FILE%.jks}_base64.txt\` - è¯ä¹¦çš„ Base64 ç¼–ç 
          - \`github_secrets_setup.md\` - GitHub Secrets è®¾ç½®æŒ‡å—
          
          ## ä½¿ç”¨æ–¹æ³•
          
          ### æœ¬åœ°ä½¿ç”¨
          1. å°†æ­¤ç›®å½•å¤åˆ¶åˆ°é¡¹ç›®ä¸­
          2. åœ¨ \`example/android/key.properties\` ä¸­é…ç½®è·¯å¾„
          
          ### GitHub Actions ä½¿ç”¨
          1. æŸ¥çœ‹ \`github_secrets_setup.md\`
          2. è®¾ç½®ç›¸åº”çš„ Secrets
          3. åœ¨å·¥ä½œæµä¸­ä½¿ç”¨
          
          ## å®‰å…¨æé†’
          
          - ðŸ”’ è¿™æ˜¯ç”Ÿäº§è¯ä¹¦ï¼Œè¯·å¦¥å–„ä¿ç®¡
          - ðŸ”’ ä¸è¦åˆ é™¤æˆ–ä¸¢å¤±æ­¤è¯ä¹¦
          - ðŸ”’ æ‰€æœ‰åº”ç”¨æ›´æ–°éƒ½éœ€è¦ä½¿ç”¨ç›¸åŒçš„è¯ä¹¦
          - âš ï¸  å»ºè®®ç«‹å³å¤‡ä»½åˆ°å®‰å…¨ä½ç½®
          EOF
          
          echo "âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
          
      - name: Create master keys directory structure
        run: |
          # ç¡®ä¿ keys æ ¹ç›®å½•å­˜åœ¨
          mkdir -p keys
          
          # åˆ›å»ºæ€»è§ˆ README
          cat > keys/README.md << 'EOF'
          # è¯ä¹¦ç›®å½•
          
          æ­¤ç›®å½•åŒ…å«æ‰€æœ‰ç”Ÿæˆçš„åº”ç”¨è¯ä¹¦ã€‚æ¯ä¸ªå­ç›®å½•å¯¹åº”ä¸€ä¸ªä¸åŒçš„è¯ä¹¦é…ç½®ã€‚
          
          ## ç›®å½•ç»“æž„
          
          ```
          keys/
          â”œâ”€â”€ README.md (æ­¤æ–‡ä»¶)
          â””â”€â”€ [è¯ä¹¦åç§°]/
              â”œâ”€â”€ [è¯ä¹¦åç§°]_keystore.jks
              â”œâ”€â”€ [è¯ä¹¦åç§°]_keystore_base64.txt
              â”œâ”€â”€ key.properties
              â”œâ”€â”€ github_secrets_setup.md
              â””â”€â”€ README.md
          ```
          
          ## ä½¿ç”¨æŒ‡å—
          
          1. é€‰æ‹©å¯¹åº”çš„è¯ä¹¦ç›®å½•
          2. æŸ¥çœ‹è¯¥ç›®å½•ä¸‹çš„ README.md
          3. æŒ‰ç…§è¯´æ˜Žé…ç½®é¡¹ç›®
          
          ## å®‰å…¨æé†’
          
          âš ï¸  è¯·å‹¿å°†åŒ…å« base64 çš„æ–‡ä»¶æäº¤åˆ°ç‰ˆæœ¬æŽ§åˆ¶
          ðŸ”’ å®šæœŸå¤‡ä»½æ‰€æœ‰è¯ä¹¦åˆ°å®‰å…¨ä½ç½®
          EOF
          
      - name: Display summary
        run: |
          KEYSTORE_DIR="${{ steps.params.outputs.keystore_dir }}"
          KEYSTORE_NAME="${{ steps.params.outputs.keystore_name }}"
          
          echo ""
          echo "=== ðŸŽ‰ è¯ä¹¦ç”Ÿæˆå®Œæˆ ==="
          echo ""
          echo "ðŸ“ è¯ä¹¦ä½ç½®: $KEYSTORE_DIR"
          echo ""
          echo "ðŸ“‹ ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -la "$KEYSTORE_DIR" | grep -E "\.(jks|txt|md|properties)$"
          echo ""
          echo "ðŸ” GitHub Secrets åç§°å»ºè®®:"
          echo "   - ${KEYSTORE_NAME^^}_KEYSTORE_BASE64"
          echo "   - ${KEYSTORE_NAME^^}_KEYSTORE_PASSWORD"
          echo "   - ${KEYSTORE_NAME^^}_KEY_ALIAS"
          echo ""
          echo "ðŸ“¥ ä¸‹è½½ artifacts èŽ·å–æ‰€æœ‰æ–‡ä»¶"
          
      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ  .gitignore
          echo "*_base64.txt" > "${{ steps.params.outputs.keystore_dir }}/.gitignore"
          
          git add keys/
          git diff --staged --quiet || git commit -m "Add ${{ steps.params.outputs.keystore_name }} keystore [skip ci]"
          git push || echo "No changes to push"
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.params.outputs.keystore_name }}-keystore
          path: ${{ steps.params.outputs.keystore_dir }}
          retention-days: 90
